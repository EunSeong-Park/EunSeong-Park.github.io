---
title: "Summary & Exercises"
tags: Computer-Architecture
toc: true
---

# Intro
컴퓨터 구조(computer architecture)에서 필요한 공식이나 정보, 또는 연습문제, 그리고 해결 아이디어를 정리해보았다.


# Summary & Exercise
## Amdahl's Law
암달의 법칙은 다음과 같이 나타내어진다.

$T_{\text{improved}} = \frac{T_{\text{affected}}}{\text{(improvement factor)}} + T_{\text{unaffected}}$

개선은 병렬화를 포함하며, 병렬화에 따른 속도 향상도 암달의 법칙에 의해 다음과 같이 나타낼 수 있다.

$\text{Speed up} = {1 \over (1-F_{\text{parallelizable}}) + \frac{F_{\text{parallelizable}}}{\text{parallel}}}$

### Exercise 1
110초 걸리는 어떤 프로그램에서 100초는 곱셈에 의해 소요된다. 이 프로그램을 다섯 배 빠르게 실행되게 하려면, 어느 정도의 곱셈 속도 개선을 수행해야 하는가?

#### Answer
$T_{\text{improved}} = \frac{T_{\text{affected}}}{\text{(improvement factor)}} + T_{\text{unaffected}}$ = $\frac{100}{n} + 10 = 110 * \frac{1}{5} = 22$, $n = 8.33$. 즉, 8.33배 개선되어야 한다.

## Performance

- $\text{Performance} = {1 \over \text{Execution time}}$
- $\text{Total CPI} = \sum (CPI_i * {\text{# instruction} \over \text{# total instruction}})$
- $\text{CPU Time} = \text{(# instruction)} * CPI * \text{(cucle time)}$
- $MIPS = {\text{clock rate} \over \text{CPI * 10^6}}$

### Exercise 2
동일한 명령어 집합을 가진 3개의 프로세서 P1, P2, P3은 다음과 같은 스펙을 가지고 있다.

Processor | Clock rate | CPI
---|---|---
P1 | 3 GHz | 1.5
P2 | 2.5 GHz | 1.0
P3 | 4 GHz | 2.2

초당 명령어 수로 프로세서의 성능을 비교하고(a), 각 프로세서가 어떤 프로그램을 수행하는데 10초가 걸렸다고 가정하고 각 프로세서의 사이클 수와 명령어를 구하자(b).

#### Answer
초당 명령어 수는 $\frac{\text{# of instruction}}{\text{CPU time}}$이고, 이를 변형하면 $\frac{\text{cycles}}{\text{CPI}} * \frac{1}{\text{CPU time}}$ $=\frac{\text{Clock rate}}{\text{CPI}}$다. 즉, P1은 2G, P2는 2.5G, P3은 1.82G로, P2의 성능이 가장 좋다.

또, 이에 따라, 10초가 걸리는 프로그램을 수행한다고 하면, P1은 20G, P2는 25G, P3은 18.2G의 명령어가 수행되고, 각각의 CPI에 따라, 30G, 25G, 40G개의 사이클이 각각 돌아간다. 이는 클럭 속도(clock rate)의 정의를 생각하면 당연하다.

### Exercise 3
동일한 ISA를 가진 두 프로세서, P1, P2가 있다. 명령어는 A, B, C, D, 네 종류가 있으며 각 프로세서에 대한 클럭 속도와 CPI는 다음과 같다.

Processor | Clock rate | CPI of A | CPI of B | CPI of C | CPI of D
---|---|---|---|---|---
P1 | 2.5 GHz | 1 | 2 | 3 | 3
P2 | 3 GHz | 2 | 2 | 2 | 2

그리고 $10^6$개의 명령하는 프로그램이 있는데, 이는 10%의 A, 20%의 B, 50%의 C, 20%의 D를 포함한다. 어떤 프로세서가 이 프로그램을 빠르게 구동시킬 수 있을까? 이를 알기 위해, 각 프로세서의 전체 CPI과 프로그램의 실행을 위해 필요한 클럭 사이클 수를 구해보자.

#### Answer
전체 CPI를 먼저 구해보자. P1은 $(0.1 * 1) + (0.2 * 2) + (0.5 * 3) + (0.2 * 3) = 2.6$이고, P2는 $(0.1 * 2) + (0.2 * 2) + (0.5 * 2) + (0.2 * 2) = 2.0$이다. 총 $10^6$개의 명령어를 실행하므로, 돌아가는 사이클은 각각 $2.6M$, $2.0M$으로 볼 수 있고, 클럭 속도를 고려하면 각각 $\frac{2.6M}{2.5G} = 1.04 K^{-1}$, $\frac{2.0M}{3G} = 0.67 K^{-1}$의 시간이 걸린다. 즉, P2가 더 빠르다.

## Power Issues
$P = P_{\text{static}} + P_{\text{dynamic}}$으로 볼 수 있다.

- $P_{\text{dynamic}} = \frac{1}{2}C V_{DD}^2 f_{CLK}$
- $P_{\text{static}} = I_{leak} V_{DD}$

### Exercise 4
전압이 1.25V, 클럭 속도가 3.6 GHz인 프로세서 P1는 평균 10W의 정(static)전력을, 평균 90W의 동(dynamic)전력을 소비하며, P2는 전압이 0.9V, 클럭 속도가 3.4 GHz이며, 평균 30W의 정전력, 평균 40W의 동전력을 소비한다고 가정한다.

각 프로세서의 용량성 부하(C)와 정전력이 차지하는 비율을 구하고, 정전력을 유지한 채 전체 소모 전력을 10% 감소시키려면 전압을 각각 얼마나 낮춰야하는지 확인해보자.

#### Answer
평균 소비 동전력 $P$에 대하여, $P = CV^2f$이므로, $C = \frac{P}{V^2f}$다. 따라서, P1은 $\frac{90 A * V}{(1.25 V^2)(3.6 * 10^9 s^{-1})} = \frac{90 C * s^{-1} * V}{(1.25 V^2)(3.6 * 10^9 s^{-1})} = 1.6 * 10^{-8} \frac{C}{V} = 16nF$고, 같은 방식으로 P2는 약 $14.52nF$다.

정전력의 비는 간단하게 구할 수 있다. 각각 $\frac{10W}{10W+90W} = 0.1$, $\frac{30W}{30W+40W} = 0.43$이다.

총 전력 소모는 각각 100W, 70W였다. 고로 목표는 각각 90W, 63W이며, 전압의 변화는 정전력과 동전력 모두에 영향을 끼친다는 점을 기억하자. 우리는 정전력 공식으로부터 누설 전류($I_{leak}$)를 구할 수 있고, 위에서 용량성 부하(C)를 이미 구했다. 이를 바탕으로 이차식을 세워 적절히 계산해주면 된다. 계산은 귀찮아서 생략ㅎ

## Cache Memory
가장 간단한 직접 사상 캐시를 기준으로 생각한다. 주소의 구조는 아래와 같은 규칙을 따른다.

- 블록 크기가 $2^m$바이트라면, 최하위 $m$비트는 바이트 오프셋이 된다.
- 블록 개수가 $2^n$개라면, 그 다음 하위 $n$ 비트는 캐시의 인덱스가 된다.
- 나머지 비트들은 블록 일치 여부를 확인하기 위한 태그가 된다.

평균 메모리 접근 시간, AMAT은 다음과 같이 정의된다.

$AMAT = \text{(Hit Time)} + \text{(Miss Rate)} * \text{(Miss Penalty)}$

메모리 접근 시간이 주어졌을 때, 미스 패널티는 $(\text{(I-cache miss rate)}$ $ + \text{(D-cache miss rate)} $ $ * \text{(Rate of memory access instruction)})$ $ * \text{(Memory access time)}$이다. 단, 먼저 메모리 접근 시간이 아닌, 메모리 접근 사이클을 구해서, 이를 미스 패널티를 구한다. 사이클은 중간에 끊기거나 다음 명령어로 넘어갈 수 없기 때문에, 실제로 주어진 시간보다 더 많이 필요할 수 있다.

다단계 캐시에서의 AMAT은 다음과 같이 구한다. L2 캐시 미스 비율과 글로벌 미스 비율을 혼동하지 말자.

$AMAT =$ $\text{(L1 Hit Time)} $ $+ \text{(L1 Miss Rate)} * (\text{(L2 Hit Time)} +$ $ (\text{(L2 Miss Rate)} * \text{(Miss Penalty)}))$

### Exercise 5
기본 CPI가 1이고, 클럭 속도가 4 GHz인 프로세서를 생각해보자. 전체 명령어에 대해 미스 비율은 2%고, 메모리 접근 시간은 100ns다. 단일 캐시에서의 전체 CPI와 AMAT을 구해보자. 또한, 접근 시간이 5ns, 글로벌 미스 비율이 0.5%인 L2 캐시를 추가했을 때의 전체 CPI와 AMAT을 구해보자.

#### Answer
미스 패널티를 먼저 구해보자. 클럭 속도가 4 GHz이므로, 한 사이클엔 0.25ns가 소요된다. 메모리 접근 시간이 100ns이므로, $\frac{100}{0.25} = 400$사이클의 미스 패널티가 발생한다. 즉, 1차 캐시만 존재할 때, 전체(유효) CPI는 $1+0.02 * 400=9$가 된다.

2차 캐시가 탑재된 경우엔 어떨까? 접근 시간이 5ns이므로 $\frac{5}{0.25} = 20$사이클이 소요된다. L1에 이어 L2 미스까지 발생했을 땐 400사이클이 소요된다. 즉, 전체 CPI는 $1 + 0.02 * 20 + 0.005 * 400 = 3.4$가 된다.

이제 각각의 AMAT을 구해보자. 히트 타임은 한 사이클, 0.25ns로 본다. 단일 캐시의 경우 $0.25 + 0.02 * 100 = 2.25$, 다단계 캐시의 경우 $0.25 + 0.02 * 5 + 0.005 * 100 = 0.85$가 된다.

### Exercise 6
다음과 같은 프로세서를 가정한다.

기본 CPI | 클럭 속도 | 메인 메모리 접근 시간 | L1 미스 비율 | 직접 사상 L2의 접근 시간 | 직접 사상 L2의 전체 실패율 | 8-way L2의 접근 시간 | 8-way L2의 전체 실패율
---|---|---|---|---|---|---|---
1.5 | 2 GHz | 100 ns | 7% | 12 사이클 | 3.5% | 28 사이클 | 1.5%

1차 캐시만 사용하는 경우(a), 직접 사상 L2를 사용하는 경우(b), 8-way L2를 사용하는 경우(c)의 CPI를 계산해보자. 

#### Answer
메인 메모리 접근 시간이 100 ns이므로, 사이클로 표현하면 200 사이클이 소요된다. 따라서, 단일 캐시를 사용하는 프로세서의 CPI는 $1.5 + 0.07 * 200 = 15.5$다. 직접 사상 L2를 사용하는 경우, $1.5 + 0.07 * (12 + 0.035 * 200) = 2.83$이고, 8-way L2를 사용하는 경우, $1.5 + 0.07 * (28 + 0.015 * 200) = 3.67$이다.

### Exercise 7
두 프로세서에, P1, P2는 각각 다음과 같은 스펙의 L1 캐시를 가진다. 캐시의 크기가 클수록 히트 타임이 길어지는 경향이 고려되었다. 메인 메모리 접근 시간은 70 ns고, 전체 명령어의 36%가 메모리 접근 명령어다. 

X | L1 크기 | L1 미스 비율 | L1 히트 타임
---|---|---|---
P1 | 2 KiB | 8.0% | 0.66 ns
P2 | 4 KiB | 6.0% | 0.90 ns

L1의 히트 타임이 프로세서의 사이클 시간을 결정하며, 메모리 접근에 의한 지연이 없을 때의 CPI가 1.0이라 가정한다. 각 프로세서의 클럭 속도와 AMAT, 그리고 전체 CPI를 구해보자.(a)

또한, 위의 상황에서, P1에 L2 캐시를 도입하여 다단계 캐시(multi-level cache)를 구현하려 한다. L2 캐시의 스펙은 아래와 같고, 나머지 조건은 전부 동일하다. L2 미스 비율은 L2 캐시에서의 local miss에 대한 비율이다. 이 때, L2 캐시가 도입된 P1의 AMAT, CPI를 구하고, P2와 비교해보자. 그리고 느린 쪽의 프로세서가 빠른 쪽의 프로세서를 따라가기 위해 L1 캐시의 미스 비율을 어느 정도로 낮춰야 하는지도 확인해보자.(b)

캐시 크기 | L2 미스 비율 | L2 히트 타임
---|---|---
1 MiB | 95% | 5.62 ns

#### Answer
위의 문제와 비슷하지만, 글로벌 미스 대신 L2 미스 비율이 주어졌고, 메모리 접근 시간이 사이클에 대해 나누어떨어지지 않는다. 또, I-캐시 미스에 대한 고려를 해주어야한다는 점을 잊지 말자. 먼저 해결 순서를 정리해보자.

- 메모리 접근 사이클(미스 패널티) 계산. 이 때 사이클은 반드시 정수다.
- AMAT 계산.
- CPI 계산. CPI는 명령어 미스 비율을 포함한다.

P1을 먼저 구해보자. P1의 메모리 접근 사이클은 $\frac{70}{0.66}$을 올림하여 107사이클이다. 이를 이용하여 AMAT을 사이클로 구해보자. $1 + 0.08 * 107 = 9.56$사이클이다. 이를 시간으로 변환하면 $6.31 ns$가 나온다.

이제 P1의 CPI를 계산해보자. CPI는 명령어 캐시 미스도 고려해주어야 한다. 명령어 캐시 미스는 모든 명령어에 대해 적용된다는 점을 기억하자. 데이터 캐시 미스는 전체 명령어의 36%이므로, 전체 CPI를 다음과 같이 표현할 수 있다.

$CPI = 1 + (1 * 0.08 * 107) + (0.36 * 0.08 * 107) = 12.6416$

같은 방식으로 P2를 계산한다. P2의 메모리 접근 사이클은 $\frac{70}{0.90}$을 올림하여 78사이클이다. 그에 따라, AMAT을 사이클 단위로 표현하면 $1 + 0.06 * 78 = 5.68$사이클이고, $5.68 ns$로 나타낼 수 있다.

P2의 CPI는 어떨까? 명령어 비율은 P1과 똑같으므로, 전체 CPI를 다음과 같이 계산하자.

$CPI = 1 + (1 * 0.06 * 78) + (0.36 * 0.06 * 78) = 7.3648$

즉, 프로세서 P2가 더 빠르다.

이제 다단계 캐시를 적용한 P1과 비교해보자. 우선 미스 패널티를 다시 계산한다. L1 실패시 L2 히트 타임은 $5.62 ns$로, 사이클로 나타내면 $\frac{5.62}{0.66}$을 올림하여 9사이클이다. 95% 확률로 107사이클이 소요되는 메모리 접근을 수행하므로, 미스 패널티는 $9+0.95 * 107 = 110.65$사이클이다. 즉, AMAT은 $1+0.08 * 110.65 = 9.852$사이클, 혹은 $6.50 ns$다.

CPI는 어떨까? $1 + (1 * 0.08 * 110.65) + (0.36 * 0.08 * 110.65) = 13.03872$다. 단일 캐시의 P1보다 성능이 떨어졌다. 이 상태에서 P1의 L1 미스 비율을 줄여 P2의 성능을 따라가려면, 미스 비율이 어떻게 되어야 할까?

P2와 명령어 실행 시간을 맞춘다고 가정하자. $CPI_1 * 0.66 = CPI_2 * 0.90$을 만족해야 하므로, $CPI_1 = 10.04$가 되어야 한다. $CPI = 1 + (\text{mr}) * 110.65 + (\text{mr}) * 0.36 * 110.65$가 10.04이므로, 미스 비율은 6%까지 줄어들어야 한다.

## Vritual Memory
페이지의 크기가 $2^k$바이트라면, 가상 주소의 하위 $k$비트가 페이지 오프셋을 차지하고, (32비트 주소 체계라면) 상위 $32-k$비트가 VPN을 지정한다. 

