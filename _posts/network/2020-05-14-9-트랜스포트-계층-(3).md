---
title:  "9 트랜스포트 계층 (3)"
toc: true
tags: Networking
---

# Intro
지금까지 reliable data transfer가 어떻게 동작하는지 알아보았다. 이번엔 TCP에 대해 조금 더 자세히 살펴보도록 한다.


# Characteristics
본격적으로 들어가기에 앞서, TCP의 주요 특징에 대해 가볍게 알아보자.

- Point-to-point : 연결은 단일 송신자와 단일 수신자에 의해 이루어진다.
- Reliable, in-order byte stream : 데이터는 손실, 손상, 순서 변경 없이 전송되고, 바이트 스트림이기 때문에 message boundary가 없다. message boundary는 이런 느낌으로 이해하면 좋을 듯 싶다. [(링크)](https://stackoverflow.com/questions/9563563/what-is-a-message-boundary)
- Pipelined : 혼잡(congestion) 및 흐름(flow) 제어가 윈도우 크기를 결정하는 파이프라이닝을 수반한다.
- Full duplex data : 한 연결에 양방향의 데이터 흐름이 존재한다.
- Connection-oriented : 데이터 교환 전 핸드셰이킹(handshaking)으로 연결을 설정한다.
- Flow controlled : 흐름 제어(flow control)를 통해 송신자는 수신자를 overwhelm하지 않는다. 즉, 수신보다 빠른 송신 속도로 인해 큐를 밀어버리는 등의 문제가 발생하지 않도록 송신 측의 데이터 전송 속도를 줄인다.

와, 벌써 다 배운 것 같다.

TCP 세그먼트(segment)는 다음과 같은 형식을 가진다.

![](/imgs/network/net34.png)

이제 하나하나 TCP의 구성 요소와 작동 방식에 대해 알아보자.

## Sequence number & ACK
TCP에서의 Sequence number는 세그먼트의 데이터가 가지는 스트림 위에서의 첫 바이트다. ACK(ACKnowledgement)는 culumative하여, n이라는 sequence number에 대한 ACK가 도착하면 최초 번호부터 n-1까지의 데이터가 성공적으로 도착했음을 의미한다.

Telnet의 예시를 통해 간단히 알아보자. `Seq=42`에 대한 세그먼트에 대해, `ACK=43`, `seq=79`인 응답이 돌아왔다. 그리고 이에 대한 ACK로 `ACK=80`인 응답이 다시 전해졌다. 

![](/imgs/network/net35.png)

## TCP RTT & Time Out
이전에도 배웠지만, RTT(Round Trip Time)은 timeout value를 설정하는 데 활용될 수 있고, 이는 상황에 따라 어느 정도 변할 수 있기 때문에 그러한 편차를 고려해야 한다. 만약 너무 timeout value가 짧으면 정상적인 송수신에서도 타임아웃이 발생할 수 있어 불필요한 재전송이 발생한다. 또, 너무 길면 손실 및 손상에 대해 느린 대처를 할 수 밖에 없다.

그나저나, 그럼 RTT를 어떻게 측정 및 확인할까? SampleRTT를 이용해 segment transmission의 왕복 시간을 측정할 수 있다. 다만, SampleRTT도 그 값이 들쭉날쭉할 수 있기 때문에, 일종의 보정 작업(smoothing)이 필요하다. 이전의 값에 영향을 받되, 그 영향이 기하급수적으로 줄어드는 EWMA(Exponentially Weighted Moving Average)를 사용하면 다음과 같이 나타낼 수 있을 것이다.

    EstimatedRTT = (1-alpha)EstimatedRTT + (alpha)SampleRTT

파라미터 (alpha)로 이전 값에 대한 의존 정도를 설정할 수 있다. 보통은 0.125 정도로 설정하는 것 같다. 아무튼 이걸로 꽤 그럴듯한 RTT 추정치를 얻을 수 있다. 이제 여기에 더해, 약간의 safety margin을 더해주어 타임아웃을 설정할 수 있을 것이다. Safety margin은 어떻게 설정해야 하나? 아마 RTT의 추정치가 편차가 크다면 safety margin 또한 크게 설정해주는 게 안전할 것이다. `DevRTT`를 다음과 같이 정의하자.

    DevRTT = (1-beta)DevRTT + (beta)|SampleRTT-EstimatedRTT|

이제 최종적으로 타임아웃을 이렇게 정한다. Normal함을 가정하면 4Dev로는 충분히 안전하다고 볼 수 있다.

    Timeout = EstimatedRTT + 4DevRTT




